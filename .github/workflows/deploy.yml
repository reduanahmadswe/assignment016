name: Deploy OriyetWeb (Prod)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Start ssh-agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Deploy Backend & Frontend
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.VPS_HOST }} << 'EOF'
            set -e

            PROJECT_DIR="/root/oriyet"
            echo "[$(date +'%Y-%m-%d %H:%M:%S')] ðŸš€ Deploy started"
            echo "ðŸ“‚ Project dir: $PROJECT_DIR"

            cd "$PROJECT_DIR"

            echo "[$(date +'%Y-%m-%d %H:%M:%S')] ðŸ“¥ Pull latest code"
            git fetch origin
            git reset --hard origin/main

            # =====================
            # =====================
            # Backend (DEV MODE)
            # =====================
            echo "[$(date +'%Y-%m-%d %H:%M:%S')] âš™ï¸ Backend (dev mode)"
            cd backend
            pnpm install
            npx prisma migrate deploy
            pm2 restart oriyet-backend || pm2 start ecosystem.config.cjs --only oriyet-backend


            # =====================
            # Frontend
            # =====================
            echo "ðŸŽ¨ Frontend build"
            cd ../frontend
            pnpm install
            pnpm build
            pm2 restart oriyet-frontend || pm2 start ecosystem.config.cjs --only oriyet-frontend

            pm2 save
            echo "âœ… Deploy completed successfully"
            echo "[$(date +'%Y-%m-%d %H:%M:%S')] âœ… Deploy completed successfully"
          EOF
