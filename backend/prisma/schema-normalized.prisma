// Prisma Schema for ORIYET Education and Event Platform
// FULLY NORMALIZED VERSION (3NF+)
// MySQL Compatible

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================================
// LOOKUP TABLES (Reference Data)
// ============================================================

model UserRole {
  id    Int    @id @default(autoincrement())
  code  String @unique // 'user', 'admin'
  label String

  users User[]

  @@map("user_roles")
}

model AuthProvider {
  id    Int    @id @default(autoincrement())
  code  String @unique // 'local', 'google'
  label String

  users User[]

  @@map("auth_providers")
}

model EventType {
  id    Int    @id @default(autoincrement())
  code  String @unique // 'seminar', 'workshop', 'webinar', 'bootcamp', 'conference', 'hackathon'
  label String

  events Event[]

  @@map("event_types")
}

model EventMode {
  id    Int    @id @default(autoincrement())
  code  String @unique // 'online', 'offline', 'hybrid'
  label String

  events Event[]

  @@map("event_modes")
}

model EventStatus {
  id    Int    @id @default(autoincrement())
  code  String @unique // 'upcoming', 'ongoing', 'completed', 'cancelled'
  label String

  events Event[]

  @@map("event_statuses")
}

model RegistrationStatus {
  id    Int    @id @default(autoincrement())
  code  String @unique // 'open', 'closed', 'full'
  label String

  events Event[]

  @@map("registration_statuses")
}

model EventRegistrationStatus {
  id    Int    @id @default(autoincrement())
  code  String @unique // 'pending', 'confirmed', 'cancelled', 'refunded'
  label String

  eventRegistrations EventRegistration[]

  @@map("event_registration_statuses")
}

model PaymentStatus {
  id    Int    @id @default(autoincrement())
  code  String @unique // 'not_required', 'pending', 'completed', 'failed', 'cancelled', 'expired', 'refunded'
  label String

  eventRegistrations  EventRegistration[]
  paymentTransactions PaymentTransaction[]

  @@map("payment_statuses")
}

model PaymentGateway {
  id    Int    @id @default(autoincrement())
  code  String @unique // 'uddoktapay', 'stripe', 'paypal'
  label String

  paymentTransactions PaymentTransaction[]

  @@map("payment_gateways")
}

model BlogStatus {
  id    Int    @id @default(autoincrement())
  code  String @unique // 'draft', 'published', 'archived'
  label String

  blogPosts BlogPost[]

  @@map("blog_statuses")
}

model OpportunityStatus {
  id    Int    @id @default(autoincrement())
  code  String @unique // 'open', 'closed'
  label String

  opportunities Opportunity[]

  @@map("opportunity_statuses")
}

model OpportunityType {
  id    Int    @id @default(autoincrement())
  code  String @unique // 'INTERNSHIP', 'FELLOWSHIP', 'PROGRAM', 'SCHOLARSHIP'
  label String

  opportunities Opportunity[]

  @@map("opportunity_types")
}

model ApplicationStatus {
  id    Int    @id @default(autoincrement())
  code  String @unique // 'pending', 'reviewed', 'accepted', 'rejected'
  label String

  opportunityApplications OpportunityApplication[]

  @@map("application_statuses")
}

model OtpType {
  id    Int    @id @default(autoincrement())
  code  String @unique // 'verification', 'password_reset', '2fa'
  label String

  otpCodes OtpCode[]

  @@map("otp_types")
}

model HostRole {
  id    Int    @id @default(autoincrement())
  code  String @unique // 'host', 'speaker', 'moderator', 'panelist'
  label String

  eventHosts  EventHost[]
  eventGuests EventGuest[]

  @@map("host_roles")
}

model OnlinePlatform {
  id    Int    @id @default(autoincrement())
  code  String @unique // 'zoom', 'google_meet', 'microsoft_teams', 'other'
  label String

  events Event[]

  @@map("online_platforms")
}

// ============================================================
// CORE ENTITIES
// ============================================================

model User {
  id               Int      @id @default(autoincrement())
  email            String   @unique
  password         String?
  name             String
  phone            String?
  avatar           String?
  roleId           Int      @map("role_id")
  authProviderId   Int      @map("auth_provider_id")
  googleId         String?  @unique @map("google_id")
  isVerified       Boolean  @default(false) @map("is_verified")
  isActive         Boolean  @default(true) @map("is_active")
  twoFactorEnabled Boolean  @default(false) @map("two_factor_enabled")
  twoFactorSecret  String?  @map("two_factor_secret")
  emailOtpEnabled  Boolean  @default(true) @map("email_otp_enabled")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  role                UserRole             @relation(fields: [roleId], references: [id])
  authProvider        AuthProvider         @relation(fields: [authProviderId], references: [id])
  refreshTokens       RefreshToken[]
  eventsCreated       Event[]              @relation("EventCreator")
  registrations       EventRegistration[]
  paymentTransactions PaymentTransaction[]
  certificates        Certificate[]
  blogPosts           BlogPost[]
  reviews             Review[]

  @@index([roleId])
  @@index([authProviderId])
  @@map("users")
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  token     String   @db.Text
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("refresh_tokens")
}

model OtpCode {
  id        Int      @id @default(autoincrement())
  email     String
  code      String
  typeId    Int      @map("type_id")
  expiresAt DateTime @map("expires_at")
  isUsed    Boolean  @default(false) @map("is_used")
  createdAt DateTime @default(now()) @map("created_at")

  type OtpType @relation(fields: [typeId], references: [id])

  @@index([typeId])
  @@index([email, isUsed])
  @@map("otp_codes")
}

model PendingRegistration {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String
  phone     String?
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("pending_registrations")
}

// ============================================================
// EVENT MANAGEMENT
// ============================================================

model Event {
  id                     Int       @id @default(autoincrement())
  title                  String
  slug                   String    @unique
  description            String?   @db.Text
  category               String?   @db.Text
  content                String?   @db.LongText
  thumbnail              String?
  eventTypeId            Int       @map("event_type_id")
  eventModeId            Int       @map("event_mode_id")
  venueDetails           String?   @map("venue_details") @db.Text
  onlineLink             String?   @map("online_link")
  onlinePlatformId       Int?      @map("online_platform_id")
  startDate              DateTime  @map("start_date")
  endDate                DateTime  @map("end_date")
  registrationDeadline   DateTime? @map("registration_deadline")
  isFree                 Boolean   @default(true) @map("is_free")
  price                  Float     @default(0)
  currency               String    @default("BDT")
  maxParticipants        Int?      @map("max_participants")
  currentParticipants    Int       @default(0) @map("current_participants")
  hasCertificate         Boolean   @default(false) @map("has_certificate")
  registrationStatusId   Int       @map("registration_status_id")
  eventStatusId          Int       @map("event_status_id")
  videoLink              String?   @map("video_link")
  sessionSummary         String?   @map("session_summary")
  sessionSummaryPdf      String?   @map("session_summary_pdf")
  metaTitle              String?   @map("meta_title")
  metaDescription        String?   @map("meta_description")
  isFeatured             Boolean   @default(false) @map("is_featured")
  isPublished            Boolean   @default(false) @map("is_published")
  isCertificateAvailable Boolean   @default(false) @map("is_certificate_available")
  meetingPlatform        String?   @map("meeting_platform")
  meetingLink            String?   @map("meeting_link")
  autoSendMeetingLink    Boolean   @default(true) @map("auto_send_meeting_link")
  eventContactEmail      String?   @map("event_contact_email")
  eventContactPhone      String?   @map("event_contact_phone")
  participantInstructions String?  @map("participant_instructions") @db.Text
  createdBy              Int?      @map("created_by")
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  eventType          EventType          @relation(fields: [eventTypeId], references: [id])
  eventMode          EventMode          @relation(fields: [eventModeId], references: [id])
  onlinePlatform     OnlinePlatform?    @relation(fields: [onlinePlatformId], references: [id])
  registrationStatus RegistrationStatus @relation(fields: [registrationStatusId], references: [id])
  eventStatus        EventStatus        @relation(fields: [eventStatusId], references: [id])
  creator            User?              @relation("EventCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  registrations      EventRegistration[]
  certificates       Certificate[]
  eventHosts         EventHost[]
  eventGuests        EventGuest[]
  eventSignatures    EventSignature[]
  reviews            Review[]

  @@index([eventTypeId])
  @@index([eventModeId])
  @@index([eventStatusId])
  @@index([registrationStatusId])
  @@index([onlinePlatformId])
  @@index([createdBy])
  @@index([isPublished, eventStatusId])
  @@map("events")
}

model EventGuest {
  id          Int     @id @default(autoincrement())
  eventId     Int     @map("event_id")
  name        String
  email       String
  bio         String? @db.Text
  roleId      Int     @map("role_id")
  pictureLink String? @map("picture_link")
  website     String?
  cvLink      String? @map("cv_link")

  event Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  role  HostRole @relation(fields: [roleId], references: [id])

  @@index([eventId])
  @@index([roleId])
  @@map("event_guests")
}

model CertificateSignature {
  id    Int     @id @default(autoincrement())
  name  String
  title String
  image String?

  eventSignatures EventSignature[]

  @@map("certificate_signatures")
}

model EventSignature {
  id          Int @id @default(autoincrement())
  eventId     Int @map("event_id")
  signatureId Int @map("signature_id")
  position    Int // 1 or 2

  event     Event                @relation(fields: [eventId], references: [id], onDelete: Cascade)
  signature CertificateSignature @relation(fields: [signatureId], references: [id])

  @@unique([eventId, position])
  @@index([eventId])
  @@index([signatureId])
  @@map("event_signatures")
}

model EventRegistration {
  id                 Int       @id @default(autoincrement())
  eventId            Int       @map("event_id")
  userId             Int       @map("user_id")
  registrationNumber String?   @unique @map("registration_number")
  statusId           Int       @map("status_id")
  paymentStatusId    Int       @map("payment_status_id")
  paymentAmount      Float     @default(0) @map("payment_amount")
  notes              String?
  attendanceMarkedAt DateTime? @map("attendance_marked_at")
  cancelledAt        DateTime? @map("cancelled_at")
  cancelReason       String?   @map("cancel_reason")
  confirmedAt        DateTime? @map("confirmed_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  event               Event                    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user                User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  status              EventRegistrationStatus  @relation(fields: [statusId], references: [id])
  paymentStatus       PaymentStatus            @relation(fields: [paymentStatusId], references: [id])
  paymentTransactions PaymentTransaction[]
  certificates        Certificate[]

  @@unique([eventId, userId])
  @@index([statusId, paymentStatusId])
  @@index([userId, statusId])
  @@index([eventId])
  @@index([paymentStatusId])
  @@map("event_registrations")
}

model PaymentTransaction {
  id                   Int       @id @default(autoincrement())
  registrationId       Int?      @map("registration_id")
  userId               Int       @map("user_id")
  transactionId        String?   @unique @map("transaction_id")
  invoiceId            String?   @unique @map("invoice_id")
  gatewayTransactionId String?   @map("gateway_transaction_id")
  amount               Float
  currency             String    @default("BDT")
  paymentMethod        String?   @map("payment_method")
  senderNumber         String?   @map("sender_number")
  gatewayId            Int       @map("gateway_id")
  gatewayResponse      String?   @map("gateway_response") @db.Text
  statusId             Int       @map("status_id")
  paidAt               DateTime? @map("paid_at")
  refundedAt           DateTime? @map("refunded_at")
  refundReason         String?   @map("refund_reason")
  refundedBy           Int?      @map("refunded_by")
  expiresAt            DateTime? @map("expires_at")
  verificationAttempts Int       @default(0) @map("verification_attempts")
  lastVerifiedAt       DateTime? @map("last_verified_at")
  ipAddress            String?   @map("ip_address")
  userAgent            String?   @map("user_agent")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  registration EventRegistration? @relation(fields: [registrationId], references: [id], onDelete: Cascade)
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  gateway      PaymentGateway     @relation(fields: [gatewayId], references: [id])
  status       PaymentStatus      @relation(fields: [statusId], references: [id])

  @@index([statusId, createdAt])
  @@index([invoiceId, statusId])
  @@index([userId, statusId])
  @@index([expiresAt, statusId])
  @@index([registrationId])
  @@index([gatewayId])
  @@map("payment_transactions")
}

model Certificate {
  id                Int       @id @default(autoincrement())
  certificateId     String    @unique @map("certificate_id")
  registrationId    Int       @map("registration_id")
  userId            Int       @map("user_id")
  eventId           Int       @map("event_id")
  certificateUrl    String?   @map("certificate_url")
  qrCodeData        String?   @map("qr_code_data")
  issuedAt          DateTime  @default(now()) @map("issued_at")
  verificationCount Int       @default(0) @map("verification_count")
  lastVerifiedAt    DateTime? @map("last_verified_at")
  createdAt         DateTime  @default(now()) @map("created_at")

  registration             EventRegistration         @relation(fields: [registrationId], references: [id], onDelete: Cascade)
  user                     User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  event                    Event                     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  certificateVerifications CertificateVerification[]

  @@unique([registrationId, eventId, userId])
  @@index([registrationId])
  @@index([userId])
  @@index([eventId])
  @@map("certificates")
}

model CertificateVerification {
  id            Int      @id @default(autoincrement())
  certificateId Int      @map("certificate_id")
  verifiedAt    DateTime @default(now()) @map("verified_at")
  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent")

  certificate Certificate @relation(fields: [certificateId], references: [id], onDelete: Cascade)

  @@index([certificateId])
  @@map("certificate_verifications")
}

// ============================================================
// CONTENT MANAGEMENT
// ============================================================

model Tag {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now()) @map("created_at")

  blogTags BlogTag[]

  @@map("tags")
}

model BlogPost {
  id              Int       @id @default(autoincrement())
  title           String
  slug            String    @unique
  excerpt         String?
  content         String?   @db.LongText
  thumbnail       String?
  authorId        Int?      @map("author_id")
  statusId        Int       @map("status_id")
  metaTitle       String?   @map("meta_title")
  metaDescription String?   @map("meta_description")
  views           Int       @default(0)
  publishedAt     DateTime? @map("published_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  author   User?       @relation(fields: [authorId], references: [id], onDelete: SetNull)
  status   BlogStatus  @relation(fields: [statusId], references: [id])
  blogTags BlogTag[]

  @@index([authorId])
  @@index([statusId])
  @@index([publishedAt])
  @@map("blog_posts")
}

model BlogTag {
  id         Int @id @default(autoincrement())
  blogPostId Int @map("blog_post_id")
  tagId      Int @map("tag_id")

  blogPost BlogPost @relation(fields: [blogPostId], references: [id], onDelete: Cascade)
  tag      Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([blogPostId, tagId])
  @@index([blogPostId])
  @@index([tagId])
  @@map("blog_tags")
}

model Page {
  id              Int      @id @default(autoincrement())
  title           String
  slug            String   @unique
  content         String?
  metaTitle       String?  @map("meta_title")
  metaDescription String?  @map("meta_description")
  isPublished     Boolean  @default(true) @map("is_published")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("pages")
}

model Opportunity {
  id          Int       @id @default(autoincrement())
  title       String
  slug        String    @unique
  description String?   @db.Text
  typeId      Int       @map("type_id")
  location    String?
  duration    String?
  deadline    DateTime?
  statusId    Int       @map("status_id")
  banner      String?
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  type         OpportunityType          @relation(fields: [typeId], references: [id])
  status       OpportunityStatus        @relation(fields: [statusId], references: [id])
  applications OpportunityApplication[]

  @@index([typeId])
  @@index([statusId])
  @@map("opportunities")
}

model OpportunityApplication {
  id            Int      @id @default(autoincrement())
  opportunityId Int      @map("opportunity_id")
  name          String
  email         String
  phone         String?
  cvLink        String   @map("cv_link")
  imageLink     String?  @map("image_link")
  portfolioLink String?  @map("portfolio_link")
  statusId      Int      @map("status_id")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  opportunity Opportunity       @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  status      ApplicationStatus @relation(fields: [statusId], references: [id])

  @@index([opportunityId])
  @@index([statusId])
  @@map("opportunity_applications")
}

model SystemSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

model ContactMessage {
  id        Int      @id @default(autoincrement())
  name      String
  email     String
  subject   String
  message   String
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("contact_messages")
}

// ============================================================
// HOST MANAGEMENT
// ============================================================

model Host {
  id           Int      @id @default(autoincrement())
  name         String
  email        String   @unique
  bio          String?
  profileImage String?  @map("profile_image")
  cvLink       String?  @map("cv_link")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  eventHosts      EventHost[]
  hostSocialLinks HostSocialLink[]

  @@map("hosts")
}

model HostSocialLink {
  id       Int    @id @default(autoincrement())
  hostId   Int    @map("host_id")
  platform String // 'linkedin', 'twitter', 'github', 'website', etc.
  url      String

  host Host @relation(fields: [hostId], references: [id], onDelete: Cascade)

  @@index([hostId])
  @@map("host_social_links")
}

model EventHost {
  id        Int      @id @default(autoincrement())
  eventId   Int      @map("event_id")
  hostId    Int      @map("host_id")
  roleId    Int      @map("role_id")
  createdAt DateTime @default(now()) @map("created_at")

  event Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  host  Host     @relation(fields: [hostId], references: [id], onDelete: Cascade)
  role  HostRole @relation(fields: [roleId], references: [id])

  @@unique([eventId, hostId])
  @@index([eventId])
  @@index([hostId])
  @@index([roleId])
  @@map("event_hosts")
}

// ============================================================
// NEWSLETTER
// ============================================================

model Newsletter {
  id          Int       @id @default(autoincrement())
  title       String
  slug        String?   @unique
  description String?   @db.Text
  thumbnail   String?
  pdfLink     String    @map("pdf_link")
  startDate   DateTime? @map("start_date")
  endDate     DateTime? @map("end_date")
  isPublished Boolean   @default(true) @map("is_published")
  views       Int       @default(0)
  downloads   Int       @default(0)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("newsletters")
}

// ============================================================
// REVIEW SYSTEM
// ============================================================

model Review {
  id         Int       @id @default(autoincrement())
  userId     Int       @map("user_id")
  eventId    Int       @map("event_id")
  rating     Int
  comment    String?   @db.Text
  isApproved Boolean   @default(false) @map("is_approved")
  isFeatured Boolean   @default(false) @map("is_featured")
  approvedAt DateTime? @map("approved_at")
  approvedBy Int?      @map("approved_by")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
  @@index([isApproved, isFeatured])
  @@map("reviews")
}
